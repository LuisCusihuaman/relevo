-- ========================================
-- CREATE TABLES
-- ========================================
-- Schema V3: Big-bang migration to shift instances + windows model

-- Connect as RELEVO_APP user
CONNECT RELEVO_APP/TuPass123;

-- ========================================
-- BASE TABLES
-- ========================================

-- UNITS table: Hospital units/wards (e.g., ICU, General Pediatrics)
CREATE TABLE UNITS (
    ID VARCHAR2(50) PRIMARY KEY,
    NAME VARCHAR2(100) NOT NULL,
    DESCRIPTION VARCHAR2(500),
    CREATED_AT TIMESTAMP DEFAULT LOCALTIMESTAMP,
    UPDATED_AT TIMESTAMP DEFAULT LOCALTIMESTAMP
);

-- SHIFTS table: Work shift templates (e.g., Day shift 07:00-15:00, Night shift 19:00-07:00)
CREATE TABLE SHIFTS (
    ID VARCHAR2(50) PRIMARY KEY,
    NAME VARCHAR2(100) NOT NULL,
    START_TIME VARCHAR2(5) NOT NULL, -- Format: HH:MM
    END_TIME VARCHAR2(5) NOT NULL,   -- Format: HH:MM
    CREATED_AT TIMESTAMP DEFAULT LOCALTIMESTAMP,
    UPDATED_AT TIMESTAMP DEFAULT LOCALTIMESTAMP
);

-- PATIENTS table: Patient information
CREATE TABLE PATIENTS (
    ID VARCHAR2(50) PRIMARY KEY,
    NAME VARCHAR2(200) NOT NULL,
    UNIT_ID VARCHAR2(50) NOT NULL,
    DATE_OF_BIRTH DATE,
    GENDER VARCHAR2(20), -- Male, Female, Other, Unknown
    ADMISSION_DATE TIMESTAMP,
    ROOM_NUMBER VARCHAR2(20),
    DIAGNOSIS VARCHAR2(500),
    ALLERGIES VARCHAR2(1000),
    MEDICATIONS VARCHAR2(1000),
    NOTES VARCHAR2(1000),
    MRN VARCHAR2(20), -- Medical Record Number
    CREATED_AT TIMESTAMP DEFAULT LOCALTIMESTAMP,
    UPDATED_AT TIMESTAMP DEFAULT LOCALTIMESTAMP,
    CONSTRAINT FK_PATIENTS_UNIT FOREIGN KEY (UNIT_ID) REFERENCES UNITS(ID)
);

-- USERS table: User information from Clerk authentication
CREATE TABLE USERS (
    ID VARCHAR2(255) PRIMARY KEY, -- Clerk User ID
    EMAIL VARCHAR2(200) NOT NULL,
    FIRST_NAME VARCHAR2(100),
    LAST_NAME VARCHAR2(100),
    FULL_NAME VARCHAR2(200),
    AVATAR_URL VARCHAR2(500),
    ROLE VARCHAR2(50) DEFAULT 'user', -- admin, doctor, nurse, etc.
    IS_ACTIVE NUMBER(1) DEFAULT 1,
    LAST_LOGIN TIMESTAMP,
    CREATED_AT TIMESTAMP DEFAULT LOCALTIMESTAMP,
    UPDATED_AT TIMESTAMP DEFAULT LOCALTIMESTAMP
);

-- ========================================
-- SHIFT INSTANCES + WINDOWS
-- ========================================

-- SHIFT_INSTANCES: Real occurrence of a shift (with date/time) per unit
CREATE TABLE SHIFT_INSTANCES (
    ID VARCHAR2(50) PRIMARY KEY,
    UNIT_ID VARCHAR2(50) NOT NULL,
    SHIFT_ID VARCHAR2(50) NOT NULL,
    START_AT TIMESTAMP NOT NULL,
    END_AT TIMESTAMP NOT NULL,
    CREATED_AT TIMESTAMP DEFAULT LOCALTIMESTAMP NOT NULL,
    UPDATED_AT TIMESTAMP DEFAULT LOCALTIMESTAMP NOT NULL,
    CONSTRAINT FK_SI_UNIT FOREIGN KEY (UNIT_ID) REFERENCES UNITS(ID),
    CONSTRAINT FK_SI_SHIFT FOREIGN KEY (SHIFT_ID) REFERENCES SHIFTS(ID),
    CONSTRAINT CHK_SI_ORDER CHECK (END_AT > START_AT),
    CONSTRAINT UQ_SI_SHIFT_START UNIQUE (UNIT_ID, SHIFT_ID, START_AT),
    CONSTRAINT UQ_SI_ID_UNIT UNIQUE (ID, UNIT_ID) -- For composite FK in SHIFT_COVERAGE
);

-- SHIFT_WINDOWS: Concrete window between two shift instances (represents the "when")
CREATE TABLE SHIFT_WINDOWS (
    ID VARCHAR2(50) PRIMARY KEY,
    UNIT_ID VARCHAR2(50) NOT NULL, -- DB-enforced: unit of both instances
    FROM_SHIFT_INSTANCE_ID VARCHAR2(50) NOT NULL,
    TO_SHIFT_INSTANCE_ID VARCHAR2(50) NOT NULL,
    CREATED_AT TIMESTAMP DEFAULT LOCALTIMESTAMP NOT NULL,
    UPDATED_AT TIMESTAMP DEFAULT LOCALTIMESTAMP NOT NULL,
    CONSTRAINT FK_SW_UNIT FOREIGN KEY (UNIT_ID) REFERENCES UNITS(ID),
    -- DB-enforced: both instances must be from the same unit (without triggers)
    CONSTRAINT FK_SW_FROM_SI_UNIT FOREIGN KEY (FROM_SHIFT_INSTANCE_ID, UNIT_ID) REFERENCES SHIFT_INSTANCES(ID, UNIT_ID),
    CONSTRAINT FK_SW_TO_SI_UNIT FOREIGN KEY (TO_SHIFT_INSTANCE_ID, UNIT_ID) REFERENCES SHIFT_INSTANCES(ID, UNIT_ID),
    CONSTRAINT CHK_SW_NOT_SAME CHECK (FROM_SHIFT_INSTANCE_ID <> TO_SHIFT_INSTANCE_ID),
    CONSTRAINT UQ_SW_PAIR UNIQUE (FROM_SHIFT_INSTANCE_ID, TO_SHIFT_INSTANCE_ID),
    -- Unique needed for composite FK from HANDOVERS
    CONSTRAINT UQ_SW_ID_UNIT UNIQUE (ID, UNIT_ID)
);

-- ========================================
-- SHIFT COVERAGE
-- ========================================

-- SHIFT_COVERAGE: Coverage of shifts (who is responsible for which patient in which shift)
CREATE TABLE SHIFT_COVERAGE (
    ID VARCHAR2(50) PRIMARY KEY,
    RESPONSIBLE_USER_ID VARCHAR2(255) NOT NULL,
    PATIENT_ID VARCHAR2(50) NOT NULL,
    SHIFT_INSTANCE_ID VARCHAR2(50) NOT NULL,
    UNIT_ID VARCHAR2(50) NOT NULL, -- snapshot: unit of the shift_instance
    ASSIGNED_AT TIMESTAMP DEFAULT LOCALTIMESTAMP NOT NULL,
    IS_PRIMARY NUMBER(1) DEFAULT 0 NOT NULL, -- 1 = primary (first assigned)
    CONSTRAINT FK_SC_USER FOREIGN KEY (RESPONSIBLE_USER_ID) REFERENCES USERS(ID),
    CONSTRAINT FK_SC_PAT FOREIGN KEY (PATIENT_ID) REFERENCES PATIENTS(ID),
    CONSTRAINT FK_SC_UNIT FOREIGN KEY (UNIT_ID) REFERENCES UNITS(ID),
    -- DB-enforced: the shift_instance must be from THIS unit_id
    CONSTRAINT FK_SC_SI_UNIT FOREIGN KEY (SHIFT_INSTANCE_ID, UNIT_ID) REFERENCES SHIFT_INSTANCES(ID, UNIT_ID),
    CONSTRAINT UQ_SC UNIQUE (RESPONSIBLE_USER_ID, PATIENT_ID, SHIFT_INSTANCE_ID)
);

-- ========================================
-- HANDOVERS
-- ========================================

-- HANDOVERS table: Handovers per patient + window
-- State machine: Draft -> Ready -> InProgress -> Completed
-- Terminal states: Completed, Cancelled (mutually exclusive)
CREATE TABLE HANDOVERS (
    ID VARCHAR2(50) PRIMARY KEY,
    PATIENT_ID VARCHAR2(50) NOT NULL,
    SHIFT_WINDOW_ID VARCHAR2(50) NOT NULL,
    UNIT_ID VARCHAR2(50) NOT NULL, -- snapshot for fast scoping
    PREVIOUS_HANDOVER_ID VARCHAR2(50) NULL,
    SENDER_USER_ID VARCHAR2(255) NULL, -- the unique responsible sender (From) = primary of FROM shift
    RECEIVER_USER_ID VARCHAR2(255) NULL, -- expected receiver (optional, for reference); receiver-of-record = who completes
    CREATED_BY_USER_ID VARCHAR2(255) NULL, -- who created the handover (may differ from sender)
    CREATED_AT TIMESTAMP DEFAULT LOCALTIMESTAMP NOT NULL,
    UPDATED_AT TIMESTAMP DEFAULT LOCALTIMESTAMP NOT NULL,
    READY_AT TIMESTAMP NULL,
    READY_BY_USER_ID VARCHAR2(255),
    STARTED_AT TIMESTAMP NULL,
    STARTED_BY_USER_ID VARCHAR2(255),
    COMPLETED_AT TIMESTAMP NULL,
    COMPLETED_BY_USER_ID VARCHAR2(255),
    CANCELLED_AT TIMESTAMP NULL,
    CANCELLED_BY_USER_ID VARCHAR2(255),
    CANCEL_REASON VARCHAR2(200) NULL, -- e.g. 'AutoVoid_NoCoverage', 'Duplicate', 'ReceiverRefused', ...
    CURRENT_STATE VARCHAR2(20) GENERATED ALWAYS AS (CASE WHEN CANCELLED_AT IS NOT NULL THEN 'Cancelled' WHEN COMPLETED_AT IS NOT NULL THEN 'Completed' WHEN STARTED_AT IS NOT NULL THEN 'InProgress' WHEN READY_AT IS NOT NULL THEN 'Ready' ELSE 'Draft' END) VIRTUAL,
    CONSTRAINT FK_HO_PATIENT FOREIGN KEY (PATIENT_ID) REFERENCES PATIENTS(ID),
    CONSTRAINT FK_HO_WINDOW FOREIGN KEY (SHIFT_WINDOW_ID) REFERENCES SHIFT_WINDOWS(ID),
    CONSTRAINT FK_HO_UNIT FOREIGN KEY (UNIT_ID) REFERENCES UNITS(ID),
    -- DB-enforced: UNIT_ID must match the window's unit
    CONSTRAINT FK_HO_WINDOW_UNIT FOREIGN KEY (SHIFT_WINDOW_ID, UNIT_ID) REFERENCES SHIFT_WINDOWS(ID, UNIT_ID),
    -- DB-enforced: PREVIOUS_HANDOVER_ID must be from the same patient (composite FK)
    CONSTRAINT FK_HO_PREV_SAME_PAT FOREIGN KEY (PREVIOUS_HANDOVER_ID, PATIENT_ID) REFERENCES HANDOVERS(ID, PATIENT_ID),
    CONSTRAINT FK_HO_SENDER FOREIGN KEY (SENDER_USER_ID) REFERENCES USERS(ID),
    CONSTRAINT FK_HO_RECEIVER FOREIGN KEY (RECEIVER_USER_ID) REFERENCES USERS(ID),
    CONSTRAINT FK_HO_CREATED_BY FOREIGN KEY (CREATED_BY_USER_ID) REFERENCES USERS(ID),
    CONSTRAINT FK_HO_READY_BY FOREIGN KEY (READY_BY_USER_ID) REFERENCES USERS(ID),
    CONSTRAINT FK_HO_STARTED_BY FOREIGN KEY (STARTED_BY_USER_ID) REFERENCES USERS(ID),
    CONSTRAINT FK_HO_COMPLETED_BY FOREIGN KEY (COMPLETED_BY_USER_ID) REFERENCES USERS(ID),
    CONSTRAINT FK_HO_CANCELLED_BY FOREIGN KEY (CANCELLED_BY_USER_ID) REFERENCES USERS(ID),
    CONSTRAINT CHK_HO_RD_BY_REQ CHECK (READY_AT IS NULL OR READY_BY_USER_ID IS NOT NULL),
    CONSTRAINT CHK_HO_ST_BY_REQ CHECK (STARTED_AT IS NULL OR STARTED_BY_USER_ID IS NOT NULL),
    CONSTRAINT CHK_HO_CO_BY_REQ CHECK (COMPLETED_AT IS NULL OR COMPLETED_BY_USER_ID IS NOT NULL),
    CONSTRAINT CHK_HO_CO_REQ_ST CHECK (COMPLETED_AT IS NULL OR STARTED_AT IS NOT NULL),
    -- Inverse consistency: *_BY implies *_AT (avoids weird rows)
    CONSTRAINT CHK_HO_RD_BY_IMPLIES_RD_AT CHECK (READY_BY_USER_ID IS NULL OR READY_AT IS NOT NULL),
    CONSTRAINT CHK_HO_ST_BY_IMPLIES_ST_AT CHECK (STARTED_BY_USER_ID IS NULL OR STARTED_AT IS NOT NULL),
    CONSTRAINT CHK_HO_CO_BY_IMPLIES_CO_AT CHECK (COMPLETED_BY_USER_ID IS NULL OR COMPLETED_AT IS NOT NULL),
    CONSTRAINT CHK_HO_CAN_BY_IMPLIES_CAN_AT CHECK (CANCELLED_BY_USER_ID IS NULL OR CANCELLED_AT IS NOT NULL),
    -- Ready requires sender set (receiver-of-record is defined when completing)
    CONSTRAINT CHK_HO_READY_REQ_SENDER CHECK (READY_AT IS NULL OR SENDER_USER_ID IS NOT NULL),
    -- DB-enforced: who start/complete CANNOT be the sender (same doctor cannot be sender and receiver)
    CONSTRAINT CHK_HO_STARTED_NE_SENDER CHECK (SENDER_USER_ID IS NULL OR STARTED_BY_USER_ID IS NULL OR SENDER_USER_ID <> STARTED_BY_USER_ID),
    CONSTRAINT CHK_HO_COMPLETED_NE_SENDER CHECK (SENDER_USER_ID IS NULL OR COMPLETED_BY_USER_ID IS NULL OR SENDER_USER_ID <> COMPLETED_BY_USER_ID),
    -- Cancel: allowed even in Draft, but audited
    CONSTRAINT CHK_HO_CAN_BY_REQ CHECK (CANCELLED_AT IS NULL OR CANCELLED_BY_USER_ID IS NOT NULL),
    CONSTRAINT CHK_HO_CAN_RSN_REQ CHECK (CANCELLED_AT IS NULL OR CANCEL_REASON IS NOT NULL),
    -- Terminal states mutually exclusive: Completed vs Cancelled
    CONSTRAINT CHK_HO_ONE_TERM CHECK ((CASE WHEN COMPLETED_AT IS NOT NULL THEN 1 ELSE 0 END + CASE WHEN CANCELLED_AT IS NOT NULL THEN 1 ELSE 0 END) <= 1),
    CONSTRAINT CHK_HO_RD_AFTER_CR CHECK (READY_AT IS NULL OR READY_AT >= CREATED_AT),
    CONSTRAINT CHK_HO_ST_REQ_RD CHECK (STARTED_AT IS NULL OR READY_AT IS NOT NULL),
    CONSTRAINT CHK_HO_ST_AFTER_RD CHECK (STARTED_AT IS NULL OR STARTED_AT >= READY_AT),
    -- Temporal rules for Cancel (avoids impossible data)
    CONSTRAINT CHK_HO_CAN_AFTER_CR CHECK (CANCELLED_AT IS NULL OR CANCELLED_AT >= CREATED_AT),
    CONSTRAINT CHK_HO_CAN_AFTER_RD CHECK (CANCELLED_AT IS NULL OR READY_AT IS NULL OR CANCELLED_AT >= READY_AT),
    CONSTRAINT CHK_HO_CAN_AFTER_ST CHECK (CANCELLED_AT IS NULL OR STARTED_AT IS NULL OR CANCELLED_AT >= STARTED_AT),
    CONSTRAINT UQ_HO_PAT_WINDOW UNIQUE (PATIENT_ID, SHIFT_WINDOW_ID),
    -- DB-enforced: allows composite FK for PREVIOUS_HANDOVER_ID from same patient
    CONSTRAINT UQ_HO_ID_PAT UNIQUE (ID, PATIENT_ID)
);

-- ========================================
-- HANDOVER CONTENT TABLES
-- ========================================

-- HANDOVER_CONTENTS table: Content 1:1 with HANDOVERS
-- Contains the actual handover content (summary, situation awareness, synthesis)
CREATE TABLE HANDOVER_CONTENTS (
    HANDOVER_ID VARCHAR2(50) PRIMARY KEY,
    ILLNESS_SEVERITY VARCHAR2(20), -- Stable, Watcher, Unstable, Critical
    PATIENT_SUMMARY VARCHAR2(4000), -- Patient summary section
    SITUATION_AWARENESS VARCHAR2(4000), -- Situation awareness section
    SYNTHESIS VARCHAR2(4000), -- Synthesis section
    PATIENT_SUMMARY_STATUS VARCHAR2(20), -- Draft, Completed
    SA_STATUS VARCHAR2(20), -- Draft, Completed
    SYNTHESIS_STATUS VARCHAR2(20), -- Draft, Completed
    LAST_EDITED_BY VARCHAR2(255), -- User who last edited (Clerk User ID)
    UPDATED_AT TIMESTAMP DEFAULT LOCALTIMESTAMP NOT NULL,
    CONSTRAINT FK_HC_HANDOVER FOREIGN KEY (HANDOVER_ID) REFERENCES HANDOVERS(ID) ON DELETE CASCADE,
    CONSTRAINT FK_HC_LAST_EDITED FOREIGN KEY (LAST_EDITED_BY) REFERENCES USERS(ID),
    CONSTRAINT CHK_HC_SUM_ST CHECK (PATIENT_SUMMARY_STATUS IS NULL OR PATIENT_SUMMARY_STATUS IN ('Draft','Completed')),
    CONSTRAINT CHK_HC_SA_ST CHECK (SA_STATUS IS NULL OR SA_STATUS IN ('Draft','Completed')),
    CONSTRAINT CHK_HC_SYN_ST CHECK (SYNTHESIS_STATUS IS NULL OR SYNTHESIS_STATUS IN ('Draft','Completed'))
);

-- HANDOVER_ACTION_ITEMS table: Action items for handovers
CREATE TABLE HANDOVER_ACTION_ITEMS (
    ID VARCHAR2(50) PRIMARY KEY,
    HANDOVER_ID VARCHAR2(50) NOT NULL,
    DESCRIPTION VARCHAR2(500) NOT NULL,
    IS_COMPLETED NUMBER(1) DEFAULT 0, -- 0 = false, 1 = true
    CREATED_AT TIMESTAMP DEFAULT LOCALTIMESTAMP,
    UPDATED_AT TIMESTAMP DEFAULT LOCALTIMESTAMP,
    COMPLETED_AT TIMESTAMP,
    CONSTRAINT FK_ACTION_ITEMS_HO FOREIGN KEY (HANDOVER_ID) REFERENCES HANDOVERS(ID) ON DELETE CASCADE
);

-- HANDOVER_CONTINGENCY table: Contingency plans for handovers
CREATE TABLE HANDOVER_CONTINGENCY (
    ID VARCHAR2(50) PRIMARY KEY,
    HANDOVER_ID VARCHAR2(50) NOT NULL,
    CONDITION_TEXT VARCHAR2(1000) NOT NULL, -- Condition that triggers the plan
    ACTION_TEXT VARCHAR2(1000) NOT NULL, -- Action to take
    PRIORITY VARCHAR2(20) DEFAULT 'medium', -- low, medium, high
    STATUS VARCHAR2(20) DEFAULT 'active', -- active, planned, completed
    CREATED_BY VARCHAR2(255) NOT NULL, -- User who created (Clerk User ID)
    CREATED_AT TIMESTAMP DEFAULT LOCALTIMESTAMP,
    UPDATED_AT TIMESTAMP DEFAULT LOCALTIMESTAMP,
    CONSTRAINT FK_CONT_HO FOREIGN KEY (HANDOVER_ID) REFERENCES HANDOVERS(ID) ON DELETE CASCADE,
    CONSTRAINT FK_CONT_USER FOREIGN KEY (CREATED_BY) REFERENCES USERS(ID),
    CONSTRAINT CHK_CONT_PRIORITY CHECK (PRIORITY IN ('low','medium','high')),
    CONSTRAINT CHK_CONT_STATUS CHECK (STATUS IN ('active','planned','completed'))
);

-- HANDOVER_MESSAGES table: Discussion messages in handovers
CREATE TABLE HANDOVER_MESSAGES (
    ID VARCHAR2(50) PRIMARY KEY,
    HANDOVER_ID VARCHAR2(50) NOT NULL,
    USER_ID VARCHAR2(255) NOT NULL, -- Clerk User ID
    MESSAGE_TEXT VARCHAR2(4000) NOT NULL,
    MESSAGE_TYPE VARCHAR2(20) DEFAULT 'message', -- message, system, notification
    CREATED_AT TIMESTAMP DEFAULT LOCALTIMESTAMP,
    UPDATED_AT TIMESTAMP DEFAULT LOCALTIMESTAMP,
    CONSTRAINT FK_MSG_HO FOREIGN KEY (HANDOVER_ID) REFERENCES HANDOVERS(ID) ON DELETE CASCADE,
    CONSTRAINT FK_MSG_USER FOREIGN KEY (USER_ID) REFERENCES USERS(ID),
    CONSTRAINT CHK_MSG_TYPE CHECK (MESSAGE_TYPE IN ('message','system','notification'))
);

-- HANDOVER_MENTIONS table: User mentions in messages
CREATE TABLE HANDOVER_MENTIONS (
    ID VARCHAR2(50) PRIMARY KEY,
    MESSAGE_ID VARCHAR2(50) NOT NULL,
    MENTIONED_USER_ID VARCHAR2(255) NOT NULL, -- Clerk User ID of mentioned user
    CREATED_AT TIMESTAMP DEFAULT LOCALTIMESTAMP,
    CONSTRAINT FK_MENTION_MSG FOREIGN KEY (MESSAGE_ID) REFERENCES HANDOVER_MESSAGES(ID) ON DELETE CASCADE,
    CONSTRAINT FK_MENTION_USER FOREIGN KEY (MENTIONED_USER_ID) REFERENCES USERS(ID)
);
