-- ========================================
-- CREATE TABLES
-- ========================================

-- Connect as RELEVO_APP user
CONNECT RELEVO_APP/TuPass123;

-- UNITS table: Hospital units/wards (e.g., ICU, General Pediatrics)
CREATE TABLE UNITS (
    ID VARCHAR2(50) PRIMARY KEY,
    NAME VARCHAR2(100) NOT NULL,
    DESCRIPTION VARCHAR2(500),
    CREATED_AT TIMESTAMP DEFAULT LOCALTIMESTAMP,
    UPDATED_AT TIMESTAMP DEFAULT LOCALTIMESTAMP
);

-- SHIFTS table: Work shifts (e.g., Day shift 07:00-15:00, Night shift 19:00-07:00)
CREATE TABLE SHIFTS (
    ID VARCHAR2(50) PRIMARY KEY,
    NAME VARCHAR2(100) NOT NULL,
    START_TIME VARCHAR2(5) NOT NULL, -- Format: HH:MM
    END_TIME VARCHAR2(5) NOT NULL,   -- Format: HH:MM
    CREATED_AT TIMESTAMP DEFAULT LOCALTIMESTAMP,
    UPDATED_AT TIMESTAMP DEFAULT LOCALTIMESTAMP
);

-- PATIENTS table: Patient information
CREATE TABLE PATIENTS (
    ID VARCHAR2(50) PRIMARY KEY,
    NAME VARCHAR2(200) NOT NULL,
    UNIT_ID VARCHAR2(50) NOT NULL,
    DATE_OF_BIRTH DATE,
    GENDER VARCHAR2(20), -- Male, Female, Other, Unknown
    ADMISSION_DATE TIMESTAMP,
    ROOM_NUMBER VARCHAR2(20),
    DIAGNOSIS VARCHAR2(500),
    ALLERGIES VARCHAR2(1000),
    MEDICATIONS VARCHAR2(1000),
    NOTES VARCHAR2(1000),
    MRN VARCHAR2(20), -- Medical Record Number
    CREATED_AT TIMESTAMP DEFAULT LOCALTIMESTAMP,
    UPDATED_AT TIMESTAMP DEFAULT LOCALTIMESTAMP,
    CONSTRAINT FK_PATIENTS_UNIT FOREIGN KEY (UNIT_ID) REFERENCES UNITS(ID)
);

-- USERS table: User information from Clerk authentication
-- Must be created before USER_ASSIGNMENTS due to FK dependency
CREATE TABLE USERS (
    ID VARCHAR2(255) PRIMARY KEY, -- Clerk User ID
    EMAIL VARCHAR2(200) NOT NULL,
    FIRST_NAME VARCHAR2(100),
    LAST_NAME VARCHAR2(100),
    FULL_NAME VARCHAR2(200),
    AVATAR_URL VARCHAR2(500),
    ROLE VARCHAR2(50) DEFAULT 'user', -- admin, doctor, nurse, etc.
    IS_ACTIVE NUMBER(1) DEFAULT 1,
    LAST_LOGIN TIMESTAMP,
    CREATED_AT TIMESTAMP DEFAULT LOCALTIMESTAMP,
    UPDATED_AT TIMESTAMP DEFAULT LOCALTIMESTAMP
);

-- USER_ASSIGNMENTS table: Assignments of patients to users for specific shifts
CREATE TABLE USER_ASSIGNMENTS (
    ASSIGNMENT_ID VARCHAR2(255) PRIMARY KEY,
    USER_ID VARCHAR2(255) NOT NULL,
    SHIFT_ID VARCHAR2(50) NOT NULL,
    PATIENT_ID VARCHAR2(50) NOT NULL,
    ASSIGNED_AT TIMESTAMP DEFAULT LOCALTIMESTAMP,
    CONSTRAINT FK_ASSIGNMENTS_PATIENT FOREIGN KEY (PATIENT_ID) REFERENCES PATIENTS(ID),
    CONSTRAINT FK_ASSIGNMENTS_SHIFT FOREIGN KEY (SHIFT_ID) REFERENCES SHIFTS(ID),
    CONSTRAINT FK_ASSIGNMENTS_USER FOREIGN KEY (USER_ID) REFERENCES USERS(ID)
);

-- HANDOVERS table (Header) - Schema v2
-- State machine: Draft -> Ready -> InProgress -> Accepted -> Completed
-- Terminal states: Completed, Cancelled, Rejected, Expired (mutually exclusive)
CREATE TABLE HANDOVERS (
    ID VARCHAR2(50) PRIMARY KEY,
    PATIENT_ID VARCHAR2(50) NOT NULL,
    PREVIOUS_HANDOVER_ID VARCHAR2(50) NULL, -- Link to previous handover for this patient
    FROM_SHIFT_ID VARCHAR2(50) NOT NULL, -- Shift handing over FROM
    TO_SHIFT_ID VARCHAR2(50) NOT NULL, -- Shift receiving handover TO
    FROM_USER_ID VARCHAR2(255) NOT NULL, -- User handing over (Clerk User ID)
    TO_USER_ID VARCHAR2(255) NULL, -- User receiving handover (Clerk User ID)
    WINDOW_START_AT TIMESTAMP NOT NULL, -- Clinical handover window start
    WINDOW_END_AT TIMESTAMP NULL, -- Clinical handover window end
    CREATED_AT TIMESTAMP DEFAULT LOCALTIMESTAMP NOT NULL,
    UPDATED_AT TIMESTAMP DEFAULT LOCALTIMESTAMP NOT NULL,
    -- State timestamps (state machine driven by these)
    READY_AT TIMESTAMP NULL, -- When handover is marked ready for review
    STARTED_AT TIMESTAMP NULL, -- When receiver starts reviewing
    ACCEPTED_AT TIMESTAMP NULL, -- When receiver accepts handover
    COMPLETED_AT TIMESTAMP NULL, -- When handover is completed
    CANCELLED_AT TIMESTAMP NULL, -- When handover is cancelled
    REJECTED_AT TIMESTAMP NULL, -- When handover is rejected
    EXPIRED_AT TIMESTAMP NULL, -- When handover expires
    REJECTION_REASON VARCHAR2(4000), -- Reason for rejection (required if REJECTED_AT is set)
    -- Virtual column: calculated state (Oracle 11g+ supports GENERATED ALWAYS AS VIRTUAL)
    -- State calculation priority: Cancelled > Rejected > Expired > Completed > Accepted > InProgress > Ready > Draft
    CURRENT_STATE VARCHAR2(20) GENERATED ALWAYS AS (
        CASE
            WHEN CANCELLED_AT IS NOT NULL THEN 'Cancelled'
            WHEN REJECTED_AT  IS NOT NULL THEN 'Rejected'
            WHEN EXPIRED_AT   IS NOT NULL THEN 'Expired'
            WHEN COMPLETED_AT IS NOT NULL THEN 'Completed'
            WHEN ACCEPTED_AT  IS NOT NULL THEN 'Accepted'
            WHEN STARTED_AT   IS NOT NULL THEN 'InProgress'
            WHEN READY_AT     IS NOT NULL THEN 'Ready'
            ELSE 'Draft'
        END
    ) VIRTUAL,
    CONSTRAINT FK_HANDOVERS_PATIENT FOREIGN KEY (PATIENT_ID) REFERENCES PATIENTS(ID),
    CONSTRAINT FK_HANDOVERS_PREV FOREIGN KEY (PREVIOUS_HANDOVER_ID) REFERENCES HANDOVERS(ID),
    CONSTRAINT FK_HANDOVERS_FROM_SHIFT FOREIGN KEY (FROM_SHIFT_ID) REFERENCES SHIFTS(ID),
    CONSTRAINT FK_HANDOVERS_TO_SHIFT FOREIGN KEY (TO_SHIFT_ID) REFERENCES SHIFTS(ID),
    CONSTRAINT FK_HANDOVERS_FROM_USER FOREIGN KEY (FROM_USER_ID) REFERENCES USERS(ID),
    CONSTRAINT FK_HANDOVERS_TO_USER FOREIGN KEY (TO_USER_ID) REFERENCES USERS(ID),
    -- Window order constraint: end must be after start
    CONSTRAINT CHK_HO_WIN_ORDER CHECK (WINDOW_END_AT IS NULL OR WINDOW_END_AT > WINDOW_START_AT),
    -- State machine: dependency constraints (state X requires state Y)
    CONSTRAINT CHK_HO_ST_REQ_RD CHECK (STARTED_AT IS NULL OR READY_AT IS NOT NULL),
    CONSTRAINT CHK_HO_AC_REQ_ST CHECK (ACCEPTED_AT IS NULL OR STARTED_AT IS NOT NULL),
    CONSTRAINT CHK_HO_CO_REQ_AC CHECK (COMPLETED_AT IS NULL OR ACCEPTED_AT IS NOT NULL),
    CONSTRAINT CHK_HO_REJ_RSN CHECK (REJECTED_AT IS NULL OR REJECTION_REASON IS NOT NULL),
    -- State machine: only one terminal state allowed
    CONSTRAINT CHK_HO_ONE_TERM CHECK (
        (CASE WHEN COMPLETED_AT IS NOT NULL THEN 1 ELSE 0 END +
         CASE WHEN CANCELLED_AT IS NOT NULL THEN 1 ELSE 0 END +
         CASE WHEN REJECTED_AT IS NOT NULL THEN 1 ELSE 0 END +
         CASE WHEN EXPIRED_AT IS NOT NULL THEN 1 ELSE 0 END) <= 1
    ),
    -- Temporal order constraints (prevent absurd timestamps)
    CONSTRAINT CHK_HO_RD_AFTER_CR CHECK (READY_AT IS NULL OR READY_AT >= CREATED_AT),
    CONSTRAINT CHK_HO_ST_AFTER_RD CHECK (STARTED_AT IS NULL OR STARTED_AT >= READY_AT),
    CONSTRAINT CHK_HO_AC_AFTER_ST CHECK (ACCEPTED_AT IS NULL OR ACCEPTED_AT >= STARTED_AT),
    CONSTRAINT CHK_HO_CO_AFTER_AC CHECK (COMPLETED_AT IS NULL OR COMPLETED_AT >= ACCEPTED_AT)
);

-- HANDOVER_CONTENTS table: Content 1:1 with HANDOVERS
-- Contains the actual handover content (summary, situation awareness, synthesis)
CREATE TABLE HANDOVER_CONTENTS (
    HANDOVER_ID VARCHAR2(50) PRIMARY KEY,
    ILLNESS_SEVERITY VARCHAR2(20), -- Stable, Watcher, Unstable, Critical
    PATIENT_SUMMARY VARCHAR2(4000), -- Patient summary section
    SITUATION_AWARENESS VARCHAR2(4000), -- Situation awareness section
    SYNTHESIS VARCHAR2(4000), -- Synthesis section
    PATIENT_SUMMARY_STATUS VARCHAR2(20), -- Draft, Completed
    SA_STATUS VARCHAR2(20), -- Draft, Completed
    SYNTHESIS_STATUS VARCHAR2(20), -- Draft, Completed
    LAST_EDITED_BY VARCHAR2(255), -- User who last edited (Clerk User ID)
    UPDATED_AT TIMESTAMP DEFAULT LOCALTIMESTAMP NOT NULL,
    CONSTRAINT FK_HC_HANDOVER FOREIGN KEY (HANDOVER_ID) REFERENCES HANDOVERS(ID) ON DELETE CASCADE,
    CONSTRAINT FK_HC_LAST_EDITED FOREIGN KEY (LAST_EDITED_BY) REFERENCES USERS(ID),
    CONSTRAINT CHK_HC_SUM_ST CHECK (PATIENT_SUMMARY_STATUS IS NULL OR PATIENT_SUMMARY_STATUS IN ('Draft','Completed')),
    CONSTRAINT CHK_HC_SA_ST CHECK (SA_STATUS IS NULL OR SA_STATUS IN ('Draft','Completed')),
    CONSTRAINT CHK_HC_SYN_ST CHECK (SYNTHESIS_STATUS IS NULL OR SYNTHESIS_STATUS IN ('Draft','Completed'))
);

-- HANDOVER_ACTION_ITEMS table: Action items for handovers
CREATE TABLE HANDOVER_ACTION_ITEMS (
    ID VARCHAR2(50) PRIMARY KEY,
    HANDOVER_ID VARCHAR2(50) NOT NULL,
    DESCRIPTION VARCHAR2(500) NOT NULL,
    IS_COMPLETED NUMBER(1) DEFAULT 0, -- 0 = false, 1 = true
    CREATED_AT TIMESTAMP DEFAULT LOCALTIMESTAMP,
    UPDATED_AT TIMESTAMP DEFAULT LOCALTIMESTAMP,
    COMPLETED_AT TIMESTAMP,
    CONSTRAINT FK_ACTION_ITEMS_HANDOVER FOREIGN KEY (HANDOVER_ID) REFERENCES HANDOVERS(ID)
);

-- HANDOVER_PARTICIPANTS table: Active participants in a handover
-- Note: USER_NAME and USER_ROLE removed - use JOIN with USERS table instead
CREATE TABLE HANDOVER_PARTICIPANTS (
    ID VARCHAR2(50) PRIMARY KEY,
    HANDOVER_ID VARCHAR2(50) NOT NULL,
    USER_ID VARCHAR2(255) NOT NULL, -- Clerk User ID
    STATUS VARCHAR2(20) DEFAULT 'active', -- active, inactive, viewing
    JOINED_AT TIMESTAMP DEFAULT LOCALTIMESTAMP,
    LAST_ACTIVITY TIMESTAMP DEFAULT LOCALTIMESTAMP,
    CONSTRAINT FK_PARTICIPANTS_HANDOVER FOREIGN KEY (HANDOVER_ID) REFERENCES HANDOVERS(ID),
    CONSTRAINT FK_PARTICIPANTS_USER FOREIGN KEY (USER_ID) REFERENCES USERS(ID)
);

-- HANDOVER_CONTINGENCY table: Contingency plans for handovers
CREATE TABLE HANDOVER_CONTINGENCY (
    ID VARCHAR2(50) PRIMARY KEY,
    HANDOVER_ID VARCHAR2(50) NOT NULL,
    CONDITION_TEXT VARCHAR2(1000) NOT NULL, -- Condition that triggers the plan
    ACTION_TEXT VARCHAR2(1000) NOT NULL, -- Action to take
    PRIORITY VARCHAR2(20) DEFAULT 'medium', -- low, medium, high
    STATUS VARCHAR2(20) DEFAULT 'active', -- active, planned, completed
    CREATED_BY VARCHAR2(255) NOT NULL, -- User who created (Clerk User ID)
    CREATED_AT TIMESTAMP DEFAULT LOCALTIMESTAMP,
    UPDATED_AT TIMESTAMP DEFAULT LOCALTIMESTAMP,
    CONSTRAINT FK_CONTINGENCY_HANDOVER FOREIGN KEY (HANDOVER_ID) REFERENCES HANDOVERS(ID),
    CONSTRAINT FK_CONTINGENCY_USER FOREIGN KEY (CREATED_BY) REFERENCES USERS(ID)
);

-- HANDOVER_MESSAGES table: Discussion messages in handovers
-- Note: USER_NAME removed - use JOIN with USERS table instead
CREATE TABLE HANDOVER_MESSAGES (
    ID VARCHAR2(50) PRIMARY KEY,
    HANDOVER_ID VARCHAR2(50) NOT NULL,
    USER_ID VARCHAR2(255) NOT NULL, -- Clerk User ID
    MESSAGE_TEXT VARCHAR2(4000) NOT NULL,
    MESSAGE_TYPE VARCHAR2(20) DEFAULT 'message', -- message, system, notification
    CREATED_AT TIMESTAMP DEFAULT LOCALTIMESTAMP,
    UPDATED_AT TIMESTAMP DEFAULT LOCALTIMESTAMP,
    CONSTRAINT FK_MSG_HANDOVER FOREIGN KEY (HANDOVER_ID) REFERENCES HANDOVERS(ID),
    CONSTRAINT FK_MSG_USER FOREIGN KEY (USER_ID) REFERENCES USERS(ID)
);

-- HANDOVER_MENTIONS table: User mentions in messages
CREATE TABLE HANDOVER_MENTIONS (
    ID VARCHAR2(50) PRIMARY KEY,
    MESSAGE_ID VARCHAR2(50) NOT NULL,
    MENTIONED_USER_ID VARCHAR2(255) NOT NULL, -- Clerk User ID of mentioned user
    CREATED_AT TIMESTAMP DEFAULT LOCALTIMESTAMP,
    CONSTRAINT FK_MENTION_MESSAGE FOREIGN KEY (MESSAGE_ID) REFERENCES HANDOVER_MESSAGES(ID),
    CONSTRAINT FK_MENTION_USER FOREIGN KEY (MENTIONED_USER_ID) REFERENCES USERS(ID)
);

-- HANDOVER_ACTIVITY_LOG table: Activity log for handovers
-- Tracks state changes, edits, and other activities
CREATE TABLE HANDOVER_ACTIVITY_LOG (
    ID VARCHAR2(50) PRIMARY KEY,
    HANDOVER_ID VARCHAR2(50) NOT NULL,
    USER_ID VARCHAR2(255) NOT NULL, -- Clerk User ID
    ACTIVITY_TYPE VARCHAR2(50) NOT NULL, -- StateChange, EditContent, AddActionItem, etc.
    FROM_STATE VARCHAR2(20), -- Previous state (for state changes)
    TO_STATE VARCHAR2(20), -- New state (for state changes)
    DESCRIPTION VARCHAR2(1000),
    REASON VARCHAR2(1000),
    METADATA VARCHAR2(4000), -- JSON with additional activity data
    CREATED_AT TIMESTAMP DEFAULT LOCALTIMESTAMP NOT NULL,
    CONSTRAINT FK_ACTIVITY_HANDOVER FOREIGN KEY (HANDOVER_ID) REFERENCES HANDOVERS(ID) ON DELETE CASCADE,
    CONSTRAINT FK_ACTIVITY_USER FOREIGN KEY (USER_ID) REFERENCES USERS(ID)
);
