-- ========================================
-- VERIFICATION QUERIES
-- ========================================
-- Schema V3: Verification queries for shift instances + windows model

-- Connect as RELEVO_APP user
CONNECT RELEVO_APP/TuPass123;

-- Verify table record counts
SELECT 'UNITS' AS TABLE_NAME, COUNT(*) AS RECORD_COUNT FROM UNITS
UNION ALL
SELECT 'SHIFTS' AS TABLE_NAME, COUNT(*) AS RECORD_COUNT FROM SHIFTS
UNION ALL
SELECT 'PATIENTS' AS TABLE_NAME, COUNT(*) AS RECORD_COUNT FROM PATIENTS
UNION ALL
SELECT 'USERS' AS TABLE_NAME, COUNT(*) AS RECORD_COUNT FROM USERS
UNION ALL
SELECT 'SHIFT_INSTANCES' AS TABLE_NAME, COUNT(*) AS RECORD_COUNT FROM SHIFT_INSTANCES
UNION ALL
SELECT 'SHIFT_WINDOWS' AS TABLE_NAME, COUNT(*) AS RECORD_COUNT FROM SHIFT_WINDOWS
UNION ALL
SELECT 'SHIFT_COVERAGE' AS TABLE_NAME, COUNT(*) AS RECORD_COUNT FROM SHIFT_COVERAGE
UNION ALL
SELECT 'HANDOVERS' AS TABLE_NAME, COUNT(*) AS RECORD_COUNT FROM HANDOVERS
UNION ALL
SELECT 'VW_HANDOVERS_WITH_STATE' AS TABLE_NAME, COUNT(*) AS RECORD_COUNT FROM VW_HANDOVERS_WITH_STATE
UNION ALL
SELECT 'HANDOVER_CONTENTS' AS TABLE_NAME, COUNT(*) AS RECORD_COUNT FROM HANDOVER_CONTENTS
UNION ALL
SELECT 'HANDOVER_ACTION_ITEMS' AS TABLE_NAME, COUNT(*) AS RECORD_COUNT FROM HANDOVER_ACTION_ITEMS
UNION ALL
SELECT 'HANDOVER_CONTINGENCY' AS TABLE_NAME, COUNT(*) AS RECORD_COUNT FROM HANDOVER_CONTINGENCY
UNION ALL
SELECT 'HANDOVER_MESSAGES' AS TABLE_NAME, COUNT(*) AS RECORD_COUNT FROM HANDOVER_MESSAGES
UNION ALL
SELECT 'HANDOVER_MENTIONS' AS TABLE_NAME, COUNT(*) AS RECORD_COUNT FROM HANDOVER_MENTIONS
ORDER BY TABLE_NAME;

-- Verify shift instances are properly created
SELECT ID, UNIT_ID, SHIFT_ID, START_AT, END_AT 
FROM SHIFT_INSTANCES 
ORDER BY UNIT_ID, START_AT DESC;

-- Verify shift windows reference valid instances
SELECT sw.ID, sw.UNIT_ID, sw.FROM_SHIFT_INSTANCE_ID, sw.TO_SHIFT_INSTANCE_ID,
       si_from.START_AT AS FROM_START, si_to.START_AT AS TO_START
FROM SHIFT_WINDOWS sw
JOIN SHIFT_INSTANCES si_from ON sw.FROM_SHIFT_INSTANCE_ID = si_from.ID
JOIN SHIFT_INSTANCES si_to ON sw.TO_SHIFT_INSTANCE_ID = si_to.ID
ORDER BY sw.UNIT_ID, si_from.START_AT DESC;

-- Verify shift coverage assignments
SELECT sc.ID, sc.RESPONSIBLE_USER_ID, sc.PATIENT_ID, sc.SHIFT_INSTANCE_ID, sc.IS_PRIMARY,
       u.FULL_NAME AS USER_NAME, p.NAME AS PATIENT_NAME, si.START_AT
FROM SHIFT_COVERAGE sc
JOIN USERS u ON sc.RESPONSIBLE_USER_ID = u.ID
JOIN PATIENTS p ON sc.PATIENT_ID = p.ID
JOIN SHIFT_INSTANCES si ON sc.SHIFT_INSTANCE_ID = si.ID
ORDER BY si.START_AT DESC, sc.IS_PRIMARY DESC;

-- Verify handovers with their states
SELECT h.ID, h.PATIENT_ID, h.SHIFT_WINDOW_ID, h.CURRENT_STATE, 
       h.SENDER_USER_ID, h.COMPLETED_BY_USER_ID,
       p.NAME AS PATIENT_NAME
FROM HANDOVERS h
JOIN PATIENTS p ON h.PATIENT_ID = p.ID
ORDER BY h.CREATED_AT DESC;

-- Verify handover state transitions are valid
SELECT ID, PATIENT_ID, CURRENT_STATE, CREATED_AT, READY_AT, STARTED_AT, COMPLETED_AT, CANCELLED_AT
FROM HANDOVERS
ORDER BY CREATED_AT DESC;
